---
- name: git checkout plenv
  git:
    repo: https://github.com/tokuhirom/plenv.git
    dest: "{{ home_dir }}/.plenv"
    force: yes
  become: yes
  become_user: vagrant

- name: edit PATH plenv on .bash_profile
  lineinfile:
    dest: "{{ home_dir }}/.bash_profile"
    line: "export PATH=$HOME/.plenv/bin:$PATH"

- name: edit PATH plenv on .bashrc
  lineinfile:
    dest: "{{ home_dir }}/.bashrc"
    line: "export PATH=$HOME/.plenv/bin:$PATH"

- name: edit plenv init on .bash_profile
  lineinfile:
    dest: "{{ home_dir }}/.bash_profile"
    line: "eval \"$(plenv init -)\""

- name: edit plenv init on .bashrc
  lineinfile:
    dest: "{{ home_dir }}/.bashrc"
    line: "eval \"$(plenv init -)\""

- name: git checkout perl-build
  git:
    repo: https://github.com/tokuhirom/Perl-Build.git
    dest: "{{ home_dir }}/.plenv/plugins/perl-build"
    force: yes
  become: yes
  become_user: vagrant

- name: stat perl_path
  stat:
    path: "{{ home_dir }}/.plenv/versions/{{ perl_version | default(5.25.1) }}"
  register: is_perl_path

- name: perl installed via plenv
  command: ~/.plenv/bin/plenv install {{ perl_version | default(5.25.1) }}
  become: yes
  become_user: vagrant
  when: not is_perl_path.stat.exists

- name: plenv global
  command: ~/.plenv/bin/plenv global {{ perl_version | default(5.25.1) }}
  become: yes
  become_user: vagrant

- name: plenv rehash
  command: ~/.plenv/bin/plenv rehash
  become: yes
  become_user: vagrant

- name: cpanm module installed
  command: ~/.plenv/bin/plenv install-cpanm
  become: yes
  become_user: vagrant

- name: Carton module installed
  command: ~/.plenv/shims/cpanm Carton
  become: yes
  become_user: vagrant

- name: Server::Starter module installed
  command: ~/.plenv/shims/cpanm Server::Starter
  become: yes
  become_user: vagrant
