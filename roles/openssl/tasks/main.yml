---
- name: openssl installed
  package: name=openssl state=latest

- name: openssl-devel installed (CentOS/RHEL)
  package: name=openssl-devel state=latest
  when: ansible_os_family == 'RedHat'

- name: libssl-dev installed (Debian)
  package: name=libssl-dev state=latest
  when: ansible_os_family == 'Debian'

- name: stat ssl_path
  stat: path=/etc/pki/tls/{{ HOSTNAME }}
  register: is_ssl_path
- name: mkdir ssl
  file: path=/etc/pki/tls/{{ HOSTNAME }} state=directory owner=root
  when: not is_ssl_path.stat.exists

- name: generate a key
  command: openssl genrsa -out /etc/pki/tls/{{ HOSTNAME }}/{{ HOSTNAME }}.key 2048

- name: Generate a certificate
  command: openssl req -new -x509 -key /etc/pki/tls/{{ HOSTNAME }}/{{ HOSTNAME }}.key -out /etc/pki/tls/{{ HOSTNAME }}/{{ HOSTNAME }}.cert -days 3650 -subj /CN={{ HOSTNAME }}

- name: stat ssl.conf
  stat: path=/etc/httpd/conf.d/ssl.conf
  register: is_ssl_conf
- name: delete ssl.conf
  file: path=/etc/httpd/conf.d/ssl.conf state=absent
  when: is_ssl_conf.stat.exists
